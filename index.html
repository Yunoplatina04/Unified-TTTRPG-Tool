<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solo RPG Master Suite</title>
    
    <!-- Dependencies for fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           GLOBAL & MASTER NAVIGATION
           ========================================= */
        body {
            margin: 0;
            padding: 0;
            background-color: #111;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-y: scroll; /* Always show scrollbar to prevent jumping */
        }

        /* Master Top Bar */
        .master-nav {
            background-color: #0f172a; /* Slate 900 */
            border-bottom: 2px solid #334155;
            display: flex;
            justify-content: center;
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 9999;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .master-btn {
            background: transparent;
            color: #94a3b8;
            border: none;
            padding: 15px 25px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 4px solid transparent;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .master-btn:hover { color: #f8fafc; background-color: #1e293b; }
        .master-btn.active { color: #3b82f6; border-bottom: 4px solid #3b82f6; background-color: #1e293b; }

        /* View Switching Logic */
        .view-section { display: none !important; padding-bottom: 50px; }
        .view-section.active-view { display: block !important; }
        /* Oracle specific override to keep its flex layout */
        #view-oracle.active-view { display: flex !important; }


        /* =========================================
           1. ORACLE STYLES
           ========================================= */
        .oracle-scope {
            --or-bg: #121212;
            --or-card: #1e1e1e;
            --or-accent: #8a4fff;
            --or-text: #e0e0e0;
            
            background-color: var(--or-bg);
            color: var(--or-text);
            padding: 20px;
            justify-content: center;
        }

        .oracle-scope .container { max-width: 800px; width: 100%; display: flex; flex-direction: column; gap: 24px; }
        
        .oracle-scope h1 { 
            text-align: center; color: var(--or-accent); text-transform: uppercase; 
            letter-spacing: 2px; margin-bottom: 10px; font-size: 2em; font-weight: bold; 
        }

        .oracle-scope .section-card {
            background-color: var(--or-card);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .oracle-scope .card-header {
            font-size: 1.25rem; font-weight: bold; border-bottom: 2px solid var(--or-accent);
            padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between;
        }

        .oracle-scope button {
            width: 100%; padding: 14px; background-color: var(--or-accent);
            color: white; border: none; border-radius: 6px; font-weight: bold;
            font-size: 1rem; cursor: pointer; margin-top: 10px;
        }
        .oracle-scope button:hover { background-color: #6d33d6; }

        .oracle-scope input[type="range"] { width: 100%; accent-color: var(--or-accent); }

        .oracle-scope .result-box {
            margin-top: 20px; padding: 15px; background: #2a2a2a; border-radius: 6px;
            border-left: 4px solid #a0a0a0; text-align: center;
        }
        .oracle-scope .oracle-main-text { font-size: 1.8rem; font-weight: 800; text-transform: uppercase; }
        
        .oracle-scope .diff-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .oracle-scope .diff-col { background: #252525; padding: 15px; border-radius: 6px; text-align: center; }
        .oracle-scope .diff-val { font-size: 1.4rem; font-weight: bold; color: #00e676; }

        .oracle-scope .word-chip {
            background: #333; padding: 8px 14px; border-radius: 20px;
            border: 1px solid #444; display: inline-block; margin: 4px;
        }
        .oracle-scope .word-chip span { color: var(--or-accent); font-weight: 900; }


        /* =========================================
           2. WORLD ENGINE STYLES (Rebuilt)
           ========================================= */
        .world-scope {
            background-color: #1f2937; /* Gray 800 */
            color: #f3f4f6;
            padding: 20px;
        }
        
        .world-container { max-width: 900px; mx-auto: 0; margin: 0 auto; }

        .world-header { text-align: center; font-size: 1.8rem; font-weight: bold; margin-bottom: 20px; color: #e5e7eb; }

        /* Internal Tabs */
        .world-tabs {
            display: flex;
            overflow-x: auto;
            border-bottom: 2px solid #4b5563;
            background: #111827;
            position: sticky;
            top: 60px; /* Below master nav */
            z-index: 50;
            padding-bottom: 0;
            margin-bottom: 20px;
        }
        
        .world-tab-btn {
            background: transparent;
            color: #9ca3af;
            padding: 12px 16px;
            white-space: nowrap;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
        }
        .world-tab-btn:hover { color: white; background: #374151; }
        .world-tab-btn.active { color: #60a5fa; border-color: #60a5fa; } /* Blue 400 */

        /* Content Areas */
        .world-pane { display: none; animation: fadeIn 0.3s; }
        .world-pane.active { display: block; }

        /* Cards & UI Elements */
        .w-card {
            background-color: #374151; /* Gray 700 */
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        .w-btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            color: white;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            margin-top: 10px;
        }
        .w-btn:hover { transform: translateY(-1px); filter: brightness(110%); }
        .w-btn:active { transform: translateY(1px); }

        /* Colors */
        .bg-blue { background-color: #3b82f6; }
        .bg-green { background-color: #10b981; }
        .bg-red { background-color: #ef4444; }
        .bg-amber { background-color: #f59e0b; }
        .bg-indigo { background-color: #6366f1; }
        
        .border-left-blue { border-left: 5px solid #3b82f6; }
        .border-left-green { border-left: 5px solid #10b981; }
        .border-left-red { border-left: 5px solid #ef4444; }
        .border-left-amber { border-left: 5px solid #f59e0b; }
        .border-left-indigo { border-left: 5px solid #6366f1; }

        .text-blue { color: #60a5fa; }
        .text-red { color: #f87171; }
        .text-green { color: #34d399; }
        .text-amber { color: #fbbf24; }
        
        /* Form Elements */
        .w-select, .w-input {
            width: 100%;
            padding: 10px;
            background: #4b5563;
            border: 1px solid #6b7280;
            color: white;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        /* Tables */
        .w-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .w-table th { text-align: left; padding: 10px; background: #1f2937; color: #9ca3af; }
        .w-table td { padding: 10px; border-bottom: 1px solid #4b5563; color: #e5e7eb; vertical-align: top; }
        .w-table tr:hover { background: #4b5563; }

        /* Dice Log */
        .dice-log-item { background: #4b5563; padding: 8px; margin-bottom: 4px; border-radius: 4px; border-left: 3px solid #ef4444; }


        /* =========================================
           3. QUEST TRACKER STYLES
           ========================================= */
        .tracker-scope {
            --tr-bg: #121212;
            --tr-card: #1e1e1e;
            --tr-green: #2e7d32;
            --tr-red: #c62828;
            
            background-color: var(--tr-bg);
            color: #e0e0e0;
            padding: 20px;
        }

        .tracker-scope .controls {
            background: var(--tr-card); padding: 20px; border-radius: 8px;
            display: flex; gap: 15px; align-items: center; justify-content: center;
            flex-wrap: wrap; margin-bottom: 30px; border: 1px solid #444;
        }
        
        .tracker-scope h1 { margin: 0; font-size: 1.5rem; font-weight: bold; color: white; margin-right: 20px; }
        
        .tracker-scope input { padding: 10px; background: #252525; border: 1px solid #444; color: white; border-radius: 4px; }
        .tracker-scope button { padding: 10px 15px; cursor: pointer; border-radius: 4px; border: 1px solid #444; color: white; font-weight: bold; }
        
        .tracker-scope .btn-create { background: #0d47a1; border-color: #0d47a1; }
        
        .tracker-scope .quest-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        
        .tracker-scope .quest-card {
            background: var(--tr-card); border: 1px solid #444; border-radius: 8px; padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .tracker-scope .bar-container {
            height: 25px; background: #111; border-radius: 4px; position: relative;
            overflow: hidden; border: 1px solid #333; display: flex; margin: 5px 0;
        }
        .tracker-scope .bar-fill { height: 100%; position: absolute; z-index: 1; transition: width 0.3s; }
        .tracker-scope .fill-green { background: var(--tr-green); }
        .tracker-scope .fill-red { background: var(--tr-red); }
        .tracker-scope .ticks-layer { position: absolute; inset: 0; display: flex; z-index: 2; }
        .tracker-scope .tick { flex: 1; border-right: 1px solid rgba(0,0,0,0.5); }
        
        .tracker-scope .track-controls { display: flex; gap: 5px; }
        .tracker-scope .btn-plus-green { background: var(--tr-green); flex: 1; border: none; }
        .tracker-scope .btn-plus-red { background: var(--tr-red); flex: 1; border: none; }
        .tracker-scope .btn-minus { background: #333; width: 40px; border: none; }

    </style>
</head>
<body>

    <!-- MASTER NAVIGATION -->
    <nav class="master-nav">
        <button class="master-btn active" onclick="switchMasterView('oracle', this)">1. Oracle</button>
        <button class="master-btn" onclick="switchMasterView('world', this)">2. World Engine</button>
        <button class="master-btn" onclick="switchMasterView('tracker', this)">3. Quest Tracker</button>
    </nav>

    <!-- =========================================
         VIEW 1: ORACLE
         ========================================= -->
    <div id="view-oracle" class="view-section active-view oracle-scope">
        <div class="container">
            <h1>Solo RPG Oracle</h1>

            <!-- Narrative -->
            <div class="section-card">
                <div class="card-header">1. Narrative Oracle</div>
                <div style="margin-bottom: 20px;">
                    <label style="display:flex; justify-content:space-between;">
                        <span>Likelihood</span>
                        <span id="oddsText" style="color: var(--or-accent); font-weight:bold;">50/50</span>
                    </label>
                    <input type="range" id="oddsSlider" min="1" max="9" value="5">
                </div>
                <button onclick="rollOracle()">Ask the Oracle</button>
                <div class="result-box" id="oracleBox">
                    <div class="oracle-main-text" style="color: #666;">---</div>
                    <div style="font-size: 0.9rem; color:#888; margin-top:5px;">Define odds & roll.</div>
                </div>
            </div>

            <!-- Difficulty -->
            <div class="section-card">
                <div class="card-header">2. Difficulty Generator</div>
                <button onclick="rollDifficulty()">Roll Encounter</button>
                <div class="result-box" style="display: block; border-left: 4px solid #00e676;">
                    <div class="diff-grid">
                        <div class="diff-col">
                            <div style="font-size:0.8rem; color:#aaa;">Challenge (d100)</div>
                            <div class="diff-val" id="diffVertical">-</div>
                        </div>
                        <div class="diff-col">
                            <div style="font-size:0.8rem; color:#aaa;">Type (d6)</div>
                            <div class="diff-val" id="diffHorizontal">-</div>
                        </div>
                    </div>
                    <div id="diffDescription" style="margin-top:10px; font-size:0.9rem;">Roll to generate.</div>
                </div>
            </div>

            <!-- Words -->
            <div class="section-card">
                <div class="card-header">3. Inspiration Engine <span id="apiStatus" style="font-size:0.7rem; background:#333; padding:2px 5px; border-radius:4px; display:none;">OFFLINE</span></div>
                <button id="wordBtn" onclick="fetchWords()">Generate Words</button>
                <div class="result-box" id="wordContainer" style="display: block; border-left: 4px solid var(--or-accent);">
                    <div id="wordGrid" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;">
                        <span style="color: #666;">Waiting for input...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- =========================================
         VIEW 2: WORLD ENGINE (Fixed & Hardcoded)
         ========================================= -->
    <div id="view-world" class="view-section world-scope">
        <div class="world-container">
            <h1 class="world-header">Solo World Engine V11</h1>

            <!-- Internal Tab Navigation -->
            <div class="world-tabs">
                <button class="world-tab-btn active" onclick="openWorldTab('tab-action', this)">Action Oracle</button>
                <button class="world-tab-btn" onclick="openWorldTab('tab-sensory', this)">Sensory</button>
                <button class="world-tab-btn" onclick="openWorldTab('tab-battle', this)">Battle AI</button>
                <button class="world-tab-btn" onclick="openWorldTab('tab-dice', this)">Dice</button>
                <button class="world-tab-btn" onclick="openWorldTab('tab-manager', this)">World Engine</button>
                <button class="world-tab-btn" onclick="openWorldTab('tab-lexicon', this)">Lexicon</button>
                <button class="world-tab-btn" onclick="openWorldTab('tab-guide', this)">Guides</button>
            </div>

            <!-- 1. Action Oracle -->
            <div id="tab-action" class="world-pane active">
                <div class="w-card">
                    <h2 class="text-blue" style="font-size:1.2rem; font-weight:bold; margin-bottom:10px;">Action Oracle (3 Words)</h2>
                    <label style="display:block; margin-bottom:5px; color:#ccc;">Action Outcome:</label>
                    <select id="action-result" class="w-select">
                        <option value="success">Success (Fortune)</option>
                        <option value="failure">Failure (Misfortune)</option>
                        <option value="general">Neutral (General Mood)</option>
                    </select>
                    <button class="w-btn bg-green" onclick="generateOracleResult('action')">Generate Action Result</button>
                </div>
                <div id="oracle-result-area" class="w-card border-left-blue">
                    <h3 class="text-blue" style="font-size:1.5rem; font-weight:bold;">Welcome</h3>
                    <p style="color:#ccc;">Generate a prompt to begin.</p>
                </div>
            </div>

            <!-- 2. Sensory Oracle -->
            <div id="tab-sensory" class="world-pane">
                <div class="w-card">
                    <h2 class="text-amber" style="font-size:1.2rem; font-weight:bold; margin-bottom:10px;">Sensory Filter</h2>
                    <button class="w-btn bg-green" onclick="generateOracleResult('sensory')">Roll Sense & Discovery</button>
                </div>
                <div id="sensory-result-area" class="w-card border-left-amber">
                    <h3 class="text-amber" style="font-size:1.5rem; font-weight:bold;">Sensory Output</h3>
                    <p style="color:#ccc;">Roll to perceive the world.</p>
                </div>
            </div>

            <!-- 3. Battle AI -->
            <div id="tab-battle" class="world-pane">
                <div class="w-card">
                    <h2 class="text-red" style="font-size:1.2rem; font-weight:bold; margin-bottom:10px;">Enemy Battle AI</h2>
                    <p style="font-size:0.9rem; color:#aaa; margin-bottom:10px;">Determines next move. d100 >= 90 is Ultimate.</p>
                    <button class="w-btn bg-red" onclick="rollBattleAI()">Roll Enemy Action</button>
                </div>
                <div id="battle-ai-result" class="w-card border-left-red">
                    <h3 class="text-red" style="font-size:1.5rem; font-weight:bold;">Enemy Waiting</h3>
                </div>
            </div>

            <!-- 4. Dice Roller -->
            <div id="tab-dice" class="world-pane">
                <div class="w-card">
                    <h2 class="text-red" style="font-size:1.2rem; font-weight:bold; margin-bottom:10px;">Dice Roller</h2>
                    <div style="display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap;">
                        <button style="background:#4b5563; border:none; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="rollDiceCommand('1d4')">1d4</button>
                        <button style="background:#4b5563; border:none; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="rollDiceCommand('1d6')">1d6</button>
                        <button style="background:#4b5563; border:none; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="rollDiceCommand('1d8')">1d8</button>
                        <button style="background:#4b5563; border:none; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="rollDiceCommand('1d20')">1d20</button>
                        <button style="background:#4b5563; border:none; color:white; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="rollDiceCommand('1d100')">1d100</button>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="dice-command-input" placeholder="e.g. 2d8+3" class="w-input" style="margin:0;">
                        <button class="w-btn bg-red" style="width:auto; margin:0;" onclick="rollFromInput()">Roll</button>
                    </div>
                </div>
                <div id="dice-output-area" class="w-card border-left-red">
                    <h3 class="text-red" style="font-size:1.5rem; font-weight:bold;">Results</h3>
                </div>
                <div class="w-card">
                    <h4>History</h4>
                    <div id="dice-history-log"></div>
                </div>
            </div>

            <!-- 5. World Manager -->
            <div id="tab-manager" class="world-pane">
                <div class="w-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="text-green" style="font-weight:bold;">Weather (d10)</span>
                        <button class="bg-green" style="border:none; color:white; padding:5px 10px; border-radius:15px; cursor:pointer;" onclick="rollWeather()">Roll</button>
                    </div>
                    <div id="weather-result" style="margin-top:10px; padding:10px; background:#1f2937; border-radius:6px; text-align:center;">-</div>
                </div>
                <div class="w-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="text-green" style="font-weight:bold;">Downtime Tick (d6)</span>
                        <button class="bg-green" style="border:none; color:white; padding:5px 10px; border-radius:15px; cursor:pointer;" onclick="rollDowntimeTick()">Roll</button>
                    </div>
                    <div id="downtime-result" style="margin-top:10px; padding:10px; background:#1f2937; border-radius:6px; text-align:center;">-</div>
                </div>
                <div class="w-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="text-green" style="font-weight:bold;">Rumor Mill (3 Words)</span>
                        <button class="bg-green" style="border:none; color:white; padding:5px 10px; border-radius:15px; cursor:pointer;" onclick="generateRumor()">Generate</button>
                    </div>
                    <div id="rumor-result" style="margin-top:10px; padding:10px; background:#1f2937; border-radius:6px; text-align:center;">-</div>
                </div>
                 <div class="w-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="text-red" style="font-weight:bold;">Distress Hook</span>
                        <button class="bg-red" style="border:none; color:white; padding:5px 10px; border-radius:15px; cursor:pointer;" onclick="generateThematicHook('distress')">Generate</button>
                    </div>
                    <div id="thematic-hook-result" style="margin-top:10px; padding:10px; background:#1f2937; border-radius:6px; text-align:center;">-</div>
                </div>
            </div>

            <!-- 6. Lexicon -->
            <div id="tab-lexicon" class="world-pane">
                <div class="w-card">
                    <h2 class="text-indigo" style="font-size:1.2rem; font-weight:bold; margin-bottom:10px;">Lexicon Expansion</h2>
                    <button class="w-btn bg-indigo" onclick="generateConstrainedWords()">Generate 10 Words</button>
                </div>
                <div id="word-expansion-result" class="w-card border-left-indigo">
                    <h3 class="text-indigo">Output</h3>
                </div>
            </div>

            <!-- 7. Guides -->
            <div id="tab-guide" class="world-pane">
                <div class="w-card">
                    <h3>Interpretation Guide (d6)</h3>
                    <div id="interpretation-guide-table" style="overflow-x:auto;"></div>
                </div>
                <div class="w-card">
                    <h3>Element Links (d8)</h3>
                    <div id="element-link-table" style="overflow-x:auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- =========================================
         VIEW 3: QUEST TRACKER
         ========================================= -->
    <div id="view-tracker" class="view-section tracker-scope">
        <div class="controls">
            <h1>Quest Tracker</h1>
            <input type="text" id="newQuestName" placeholder="Quest Name" style="width:250px;">
            <input type="number" id="newQuestLength" placeholder="5" value="5" min="2" max="50" style="width:60px;">
            <button class="btn-create" onclick="addQuest()">+ Add Quest</button>
        </div>
        <div class="quest-grid" id="questContainer">
            <!-- Quests render here -->
        </div>
    </div>


    <!-- SCRIPTS -->
    <script>
        // --- MASTER NAVIGATION ---
        function switchMasterView(viewId, btn) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            // Remove active from all btns
            document.querySelectorAll('.master-btn').forEach(el => el.classList.remove('active'));
            // Activate selected
            document.getElementById('view-' + viewId).classList.add('active-view');
            btn.classList.add('active');
        }

        // --- WORLD ENGINE TAB NAVIGATION (Internal) ---
        function openWorldTab(tabId, btn) {
            // Hide all panes
            document.querySelectorAll('.world-pane').forEach(el => el.classList.remove('active'));
            // Deselect buttons
            document.querySelectorAll('.world-tab-btn').forEach(el => el.classList.remove('active'));
            // Show selected
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        /* =========================================
           PAGE 1 LOGIC (ORACLE)
           ========================================= */
        const oddsMap = [
            { label: "Impossible", threshold: 10 }, { label: "Very Unlikely", threshold: 25 }, 
            { label: "Unlikely", threshold: 35 }, { label: "Unsure", threshold: 45 },        
            { label: "50/50", threshold: 50 }, { label: "Likely", threshold: 65 },        
            { label: "Very Likely", threshold: 75 }, { label: "Near Sure", threshold: 85 },     
            { label: "Sure Thing", threshold: 95 }     
        ];
        const oddsSlider = document.getElementById('oddsSlider');
        const oddsText = document.getElementById('oddsText');
        oddsSlider.oninput = () => oddsText.textContent = oddsMap[parseInt(oddsSlider.value)-1].label;

        function rollOracle() {
            const idx = parseInt(oddsSlider.value) - 1;
            const th = oddsMap[idx].threshold;
            const roll = Math.floor(Math.random() * 100) + 1;
            const isYes = roll <= th;
            const dbl = (roll % 11 === 0) || (roll === 100); 
            const odd = (roll % 2 !== 0);

            let txt = "", col = "";
            if (isYes) {
                if (dbl) { txt = "YES, AND..."; col = "#00e676"; } 
                else if (odd) { txt = "YES, BUT..."; col = "#b9f6ca"; } 
                else { txt = "YES"; col = "#69f0ae"; }
            } else {
                if (dbl) { txt = "NO, AND..."; col = "#d50000"; } 
                else if (odd) { txt = "NO, BUT..."; col = "#ff8a80"; } 
                else { txt = "NO"; col = "#ff5252"; }
            }
            const box = document.getElementById('oracleBox');
            box.style.borderLeftColor = col;
            box.innerHTML = `<div class="oracle-main-text" style="color:${col}">${txt}</div><div class="oracle-sub-text" style="color:#aaa; font-size:0.9rem;">Rolled <strong>${roll}</strong> vs Target <strong>${th}</strong></div>`;
        }

        function rollDifficulty() {
            const d100 = Math.floor(Math.random() * 100) + 1;
            const d6 = Math.floor(Math.random() * 6) + 1;
            let txt = "", col = "";
            if (d100 <= 15) { txt = "Trivial"; col = "#aaa"; }
            else if (d100 <= 40) { txt = "Easy"; col = "#00e676"; }
            else if (d100 <= 65) { txt = "Moderate"; col = "#ffd740"; }
            else if (d100 <= 85) { txt = "Hard"; col = "#ff9100"; }
            else { txt = "Impossible"; col = "#ff5252"; }
            const doms = ["Physical", "Agility", "Mental", "Social", "Technical", "Mystical"];
            document.getElementById('diffVertical').innerHTML = `<span style="color:${col}">${d100}</span> <span style="font-size:0.7em; display:block; color:#ccc">${txt}</span>`;
            document.getElementById('diffHorizontal').innerText = doms[d6-1];
            document.getElementById('diffDescription').innerHTML = `A <strong>${txt}</strong> challenge testing <strong>${doms[d6-1]}</strong>.`;
        }

        const fallbackWords = ["Ancient", "Blade", "Castle", "Dragon", "Energy", "Forest", "Ghost", "Honor", "Iron", "Jungle", "Knight", "Lunar", "Magic", "Night", "Ocean", "Power", "Quest", "Ruins", "Shadow", "Temple", "Under", "Venom", "Witch", "Xenon", "Youth", "Zeal", "Armor", "Beast", "Crown", "Dream", "Empire", "Flame"];

        async function fetchWords() {
            const box = document.getElementById('wordGrid');
            box.innerHTML = '<span style="color:#888">Fetching...</span>';
            let pool = [];
            try {
                const res = await fetch('https://random-word-api.vercel.app/api?words=60', { signal: AbortSignal.timeout(3000) });
                if (!res.ok) throw new Error("API");
                pool = await res.json();
                document.getElementById('apiStatus').style.display = "none";
            } catch (e) {
                document.getElementById('apiStatus').style.display = "inline-block";
                pool = [...fallbackWords].sort(()=>0.5-Math.random());
            }
            const finals = [];
            const used = new Set();
            for (let w of pool) {
                let cw = w.trim();
                if (cw.length < 4) continue;
                let c = cw.charAt(0).toLowerCase();
                if (!used.has(c)) { used.add(c); finals.push(cw); }
                if (finals.length === 10) break;
            }
            box.innerHTML = finals.map(w => `<div class="word-chip"><span>${w.charAt(0)}</span>${w.slice(1)}</div>`).join('');
        }

        /* =========================================
           PAGE 2 LOGIC (WORLD ENGINE)
           ========================================= */
        const WORDS_GEN = ["Abyss", "Alchemy", "Ancient", "Anvil", "Arbiter", "Arch", "Armor", "Artifact", "Ash", "Aura", "Axe", "Baleful", "Bane", "Bard", "Bastion", "Beacon", "Beast", "Betrayal", "Blacksmith", "Blade", "Blessing", "Blizzard", "Blood", "Blight", "Bramble", "Brigand", "Bronze", "Brotherhood", "Burial", "Cairn", "Candle", "Canyon", "Caravan", "Catacomb", "Cauldron", "Cave", "Chalice", "Chaos", "Charm", "Chasm", "Chimera", "Cinder", "Citadel", "Clay", "Cloven", "Coil", "Comet", "Conqueror", "Corpse", "Crest", "Crown", "Crucible", "Crypt", "Crystal", "Cult", "Curse", "Dagger", "Dam", "Damp", "Dazzle", "Decree", "Deep", "Defeat", "Den", "Desolate", "Devour", "Dungeon", "Dust", "Dwarf", "Echo", "Elder", "Elixir", "Emerald", "Empire", "Enchant", "Enigma", "Ethereal", "Exile", "Fable", "Falcon", "Famine", "Fate", "Feral", "Fever", "Feud", "Fjord", "Flagon", "Flame", "Flicker", "Forest", "Fortress", "Fracture", "Frost", "Gallows", "Gargoyle", "Garrison", "Gate", "Gauntlet", "Ghoul", "Giant", "Glacier", "Glimmer", "Goblin", "Grave", "Grim", "Grove", "Guild", "Hail", "Halberd", "Hammer", "Hearth", "Heir", "Herald", "Hermit", "Hex", "Horde", "Horror", "Hovel", "Husk", "Idol", "Ignite", "Illusion", "Infection", "Inferno", "Intrigue", "Iron", "Island", "Jade", "Jailer", "Joust", "Jungle", "Keep", "Kin", "Kingly", "Kraken", "Labyrinth", "Lance", "Legacy", "Legend", "Lich", "Loom", "Loot", "Lore", "Magic", "Malice", "Marsh", "Masque", "Maze", "Memory", "Mercenary", "Miasma", "Minotaur", "Mire", "Monastery", "Monster", "Moondial", "Mourn", "Mushroom", "Mystic", "Necromancy", "Nexus", "Nightfall", "Nomad", "Oath", "Obsidian", "Omen", "Oracle", "Outlaw", "Paladin", "Panic", "Parchment", "Penance", "Phantom", "Pillage", "Pinnacle", "Plague", "Portal", "Potion", "Prophecy", "Pyramid", "Quarry", "Quest", "Quiver", "Rage", "Raid", "Rampart", "Relic", "Reptile", "Rift", "Rogue", "Ruins", "Rune", "Sable", "Sanctuary", "Sarcophagus", "Savage", "Scroll", "Sentinel", "Serpent", "Shade", "Shadow", "Shaman", "Siege", "Sigil", "Silver", "Slayer", "Specter", "Spell", "Spire", "Stalwart", "Starfall", "Statue", "Stealth", "Storm", "Swamp", "Sword", "Talisman", "Tavern", "Temple", "Terror", "Throne", "Tomb", "Torch", "Totem", "Treasure", "Tribe", "Tundra", "Turret", "Undead", "Unseen", "Vagrant", "Vampire", "Vault", "Venom", "Veteran", "Vial", "Vicious", "Village", "Void", "Vortex", "Vow", "Wanderer", "Warlord", "Wasteland", "Witch", "Wizened", "Wold", "Wraith", "Wreck", "Wyvern", "Yawn", "Zealot", "Zenith"];
        const WORDS_DIS = ["Ache", "Agony", "Anguish", "Anxious", "Ashen", "Aura", "Bound", "Broken", "Caged", "Captive", "Chain", "Coerced", "Collapse", "Cradle", "Crying", "Damage", "Daring", "Darkness", "Defiant", "Despair", "Desperate", "Detained", "Disguise", "Distress", "Doll", "Doom", "Doubt", "Drawn", "Enclosed", "Endure", "Escape", "Fading", "Faint", "Fear", "Feeble", "Fetter", "Frail", "Fragile", "Freedom", "Gasp", "Grave", "Grief", "Guarded", "Haunted", "Hidden", "Hollow", "Hopeless", "Humble", "Imprisoned", "Innocent", "Iron", "Jewel", "Lace", "Lament", "Lonely", "Loss", "Maiden", "Memory", "Mercy", "Misery", "Muted", "Needle", "Noble", "Orphan", "Panic", "Plea", "Poverty", "Precious", "Prison", "Purity", "Ransom", "Ravage", "Rescue", "Restrained", "Revolt", "Rope", "Ruined", "Sacrifice", "Savage", "Scarred", "Secret", "Shackled", "Shelter", "Shrine", "Silent", "Sorrow", "Strain", "Suffer", "Suppressed", "Thief", "Throat", "Tower", "Treason", "Trapped", "Trial", "Unseen", "Urgent", "Veiled", "Vengeance", "Victim", "Vigil", "Virtue", "Vulnerable", "Wail", "Warden", "Weak", "Weeping", "Woe", "Wretch", "Yoke"];
        const ADJ_VERB = ["Abhor", "Act", "Adapt", "Adhere", "Affect", "Alert", "Amazing", "Ancient", "Annoy", "Awe", "Baffle", "Brave", "Bound", "Break", "Bristle", "Burn", "Busy", "Bypass", "Calculate", "Capture", "Careful", "Charming", "Clean", "Climb", "Coerce", "Coiled", "Collapse", "Command", "Confuse", "Corrupt", "Crawl", "Creep", "Cruel", "Cry", "Damp", "Daring", "Dark", "Deceive", "Decide", "Deepen", "Defeat", "Defy", "Dense", "Destroy", "Dig", "Divert", "Divine", "Doze", "Dreamy", "Dread", "Drift", "Dwell", "Eager", "Earnest", "Echo", "Edible", "Elaborate", "Electrify", "Empty", "Engage", "Ensnare", "Erase", "Exotic", "Expand", "Faint", "Fall", "Far", "Fast", "Fearful", "Fetter", "Fight", "Find", "Fleet", "Flow", "Forbid", "Force", "Forgive", "Fragrant", "Frenzy", "Frighten", "Furious", "Gallop", "Gasp", "Giddy", "Gigantic", "Give", "Gleam", "Glitch", "Go", "Grave", "Grim", "Grow", "Grumpy", "Guard", "Guide", "Gullible", "Halt", "Handle", "Happy", "Harden", "Hasten", "Haunt", "Heavy", "Hide", "Hilarious", "Honest", "Hopeful", "Humble", "Hurry", "Ignore", "Imagine", "Imitate", "Immense", "Impact", "Imply", "Inert", "Infect", "Influence", "Intense", "Intrigue", "Invade", "Invisible", "Iron", "Irritable", "Isolate", "Jab", "Jaded", "Jail", "Jiggle", "Jolly", "Judge", "Jump", "Justify", "Keen", "Keep", "Kick", "Kind", "Know", "Knuckle", "Lament", "Laugh", "Lazy", "Leap", "Lethal", "Lie", "Light", "Limp", "Listen", "Lively", "Long", "Look", "Lose", "Loving", "Mad", "Make", "Manage", "Manic", "Marvel", "Massive", "Measure", "Mellow", "Mend", "Mighty", "Mild", "Mine", "Miss", "Mist", "Moan", "Modify", "Move", "Mute", "Nail", "Nasty", "Near", "Need", "Negotiate", "Nervous", "Neutral", "Nudge", "Nurture", "Obey", "Observe", "Occult", "Offend", "Open", "Operate", "Oppose", "Ornate", "Oust", "Outrun", "Overcome", "Oversight", "Pace", "Panic", "Paralyze", "Pass", "Peaceful", "Perplex", "Persist", "Pester", "Pierce", "Pity", "Placate", "Plot", "Polite", "Possess", "Practice", "Praise", "Prepare", "Press", "Protect", "Punish", "Push", "Puzzling", "Quake", "Qualify", "Quarrel", "Queer", "Question", "Quick", "Quiet", "Quiver", "Quote", "Radiant", "Rage", "Raise", "Rapid", "Ravage", "Reckless", "Recall", "Redeem", "Refuse", "Release", "Relish", "Renounce", "Rest", "Reveal", "Revolt", "Ride", "Riot", "Rise", "Roam", "Robust", "Rude", "Ruin", "Run", "Safe", "Savage", "Scarce", "Scare", "Scheme", "Search", "Secure", "Seize", "Select", "Serve", "Severe", "Shake", "Sharp", "Shine", "Shout", "Show", "Silent", "Sink", "Skittish", "Sleep", "Slumber", "Smart", "Smooth", "Snarl", "Solemn", "Solve", "Speak", "Spicy", "Spin", "Startle", "Steal", "Stealthy", "Stern", "Sting", "Strange", "Strong", "Stun", "Stupid", "Submit", "Subtle", "Succeed", "Suffer", "Summon", "Super", "Survive", "Swallow", "Swift", "Swing", "Taint", "Take", "Talk", "Tame", "Tear", "Terrify", "Think", "Thorny", "Threaten", "Throw", "Tight", "Timely", "Tire", "Tolerate", "Torment", "Total", "Touch", "Toxic", "Trail", "Tramp", "Trap", "Travel", "Treacherous", "Tremble", "Tricky", "Triumph", "Trust", "Try", "Twist", "Ugly", "Uncover", "Unravel", "Unseen", "Unusual", "Upset", "Urgent", "Use", "Vague", "Vanish", "Vast", "Veil", "Vengeful", "Vibrate", "Vicious", "Victorious", "Violent", "Visit", "Vivid", "Void", "Vote", "Vulnerable", "Wail", "Wait", "Wander", "Warlike", "Warm", "Warn", "Wary", "Waste", "Watch", "Weak", "Weary", "Weave", "Weird", "Whisper", "Wield", "Wild", "Win", "Wipe", "Wise", "Wish", "Witness", "Wobble", "Worry", "Wound", "Wrestle", "Write", "Yawn", "Yell", "Yield", "Young", "Yummy", "Zap", "Zealous", "Zip", "Zone", "Zoom"];

        function d(n) { return Math.floor(Math.random() * n) + 1; }
        
        function getWords(n, type='general') {
            const pool = type === 'distress' ? WORDS_DIS : WORDS_GEN;
            const res = [];
            for(let i=0; i<n; i++) res.push(pool[d(pool.length)-1]);
            return res;
        }

        const INTERP = {
            general: [["Escalation", "Danger, Difficulty", "Worsens situation"], ["Complication", "Delay, Bizarre", "Demands attention"], ["Truth Revealed", "Secrets, Motives", "Provides info"], ["Twist", "Mixed Result", "Success w/ cost"], ["Silver Lining", "Partial Success", "Fail w/ clue"], ["Success", "Victory", "Clean win"]],
            success: [["Material Gain", "Loot", "Useful item"], ["Advantage", "Position", "Tactical edge"], ["Info", "Clue", "Knowledge"], ["Favor", "Social", "Ally"], ["Reduced Threat", "Safety", "Enemy gone"], ["Opportunity", "Path", "New option"]],
            failure: [["Resource Loss", "Waste", "Lost item"], ["Worse Position", "Trapped", "Bad spot"], ["Damage", "Harm", "HP loss"], ["Escalation", "Foes", "More enemies"], ["Reputation Loss", "Social", "Lost trust"], ["Delay", "Time", "Too late"]]
        };
        const LINKS = [["Player->NPC", "Reaction"], ["NPC->Player", "Challenge"], ["Player->Env", "Change"], ["Env->Player", "Hazard"], ["NPC->Env", "Trap"], ["Env->NPC", "Boost/Hinder"], ["Party->Party", "Conflict"], ["Wild", "Reroll"]];
        
        function rollInterp(type) {
            const r = d(6);
            const row = INTERP[type][r-1];
            return { roll: r, title: row[0], focus: row[1] };
        }

        function generateOracleResult(type) {
            let guide = 'general';
            if (type === 'action') guide = document.getElementById('action-result').value;
            
            const intr = rollInterp(guide);
            const link = LINKS[d(8)-1];
            const words = getWords(3);
            const wHtml = `<div style="text-align:center; padding:15px; background:#4b5563; border-radius:8px; margin-top:10px;">
                <div style="font-size:1.5rem; font-weight:bold; letter-spacing:1px;">${words[0].toUpperCase()} & <span class="text-blue">${words[1].toUpperCase()}</span></div>
                <div style="font-size:1.1rem; color:#ccc;">${words[2].toUpperCase()}</div>
            </div>`;

            let sensoryInfo = "";
            if (type === 'sensory') {
                const senses = ["Sight", "Touch", "Smell", "Hearing", "Taste", "Sixth Sense"];
                sensoryInfo = `<div class="w-card border-left-amber"><h4 class="text-amber">Sense: ${senses[d(6)-1]}</h4></div>`;
            }

            const target = type === 'action' ? 'oracle-result-area' : 'sensory-result-area';
            document.getElementById(target).innerHTML = `
                ${sensoryInfo}
                <div style="margin-bottom:10px;">
                    <div style="margin-bottom:5px;"><strong class="text-green">Guide (${intr.roll}):</strong> ${intr.title} <span style="color:#aaa;">(${intr.focus})</span></div>
                    <div><strong class="text-amber">Link:</strong> ${link[0]} <span style="color:#aaa;">(${link[1]})</span></div>
                </div>
                ${wHtml}
            `;
        }

        function rollBattleAI() {
            const d100 = d(100);
            const isUlt = d100 >= 90;
            const acts = ["Assault", "Defend", "Restrain", "Bolster", "Torment", "Maneuver"];
            const act = acts[d(6)-1];
            const w = getWords(2, isUlt?'distress':'general');
            
            document.getElementById('battle-ai-result').innerHTML = `
                <h3 class="${isUlt?'text-red':'text-blue'}" style="font-size:1.5rem; font-weight:bold;">${isUlt?'ULTIMATE ATTACK':act}</h3>
                <p style="color:#ccc;">d100: ${d100}</p>
                <div style="margin-top:10px; font-weight:bold; font-size:1.2rem;">${w[0]} & ${w[1]}</div>
            `;
        }

        let diceHistory = [];
        function rollDiceCommand(cmd) {
            const clean = cmd.toLowerCase().replace(/\s/g,'');
            const m = clean.match(/^(\d*)d(\d+)([+\-]\d+)?$/);
            if (!m) return;
            const n = parseInt(m[1])||1;
            const s = parseInt(m[2]);
            const mod = parseInt(m[3])||0;
            let tot = 0, rolls = [];
            for(let i=0; i<n; i++) { const r=d(s); rolls.push(r); tot+=r; }
            const final = tot+mod;
            
            document.getElementById('dice-output-area').innerHTML = `<h3 class="text-red" style="font-size:2rem; font-weight:bold;">${final}</h3><p style="color:#ccc;">[${rolls.join(', ')}] ${mod? (mod>0?'+'+mod:mod) : ''}</p>`;
            
            diceHistory.unshift(`${final} (${clean})`);
            if (diceHistory.length > 5) diceHistory.pop();
            document.getElementById('dice-history-log').innerHTML = diceHistory.map(h => `<div class="dice-log-item">${h}</div>`).join('');
        }
        function rollFromInput() { rollDiceCommand(document.getElementById('dice-command-input').value); }

        function rollWeather() { 
            const w = ["Clear", "Overcast", "Light Rain", "Fog", "Steady Rain", "Storm", "Snow", "Wind", "Heat", "Unnatural"];
            document.getElementById('weather-result').innerText = w[d(10)-1]; 
        }
        function rollDowntimeTick() {
            const e = ["Recovery", "Discovery", "Expense", "Conflict", "Rumor", "Status Change"];
            document.getElementById('downtime-result').innerText = e[d(6)-1];
        }
        function generateRumor() {
            const w = getWords(3);
            const t = ["NPC", "Faction", "Ally", "Place"][d(4)-1];
            document.getElementById('rumor-result').innerText = `${t}: ${w.join(', ')}`;
        }
        function generateThematicHook() {
            const w = getWords(3, 'distress');
            document.getElementById('thematic-hook-result').innerText = w.join(' - ');
        }
        function generateConstrainedWords() {
            const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
            const res = [];
            for(let i=0; i<10; i++) {
                const l = alpha[d(26)-1];
                const match = ADJ_VERB.filter(w => w.startsWith(l));
                const word = match.length ? match[d(match.length)-1] : "---";
                res.push(`<div style="background:#374151; padding:5px; margin:2px; display:inline-block; border-radius:4px;"><strong class="text-indigo">${l}</strong> ${word}</div>`);
            }
            document.getElementById('word-expansion-result').innerHTML = res.join('');
        }

        // Render Tables
        const t1 = document.getElementById('interpretation-guide-table');
        let h1 = '<table class="w-table"><tr><th>d6</th><th>General</th><th>Success</th><th>Fail</th></tr>';
        for(let i=0; i<6; i++) h1+=`<tr><td>${i+1}</td><td>${INTERP.general[i][0]}</td><td>${INTERP.success[i][0]}</td><td>${INTERP.failure[i][0]}</td></tr>`;
        t1.innerHTML = h1+'</table>';

        const t2 = document.getElementById('element-link-table');
        let h2 = '<table class="w-table"><tr><th>d8</th><th>Link</th><th>Focus</th></tr>';
        for(let i=0; i<8; i++) h2+=`<tr><td>${i+1}</td><td>${LINKS[i][0]}</td><td>${LINKS[i][1]}</td></tr>`;
        t2.innerHTML = h2+'</table>';


        /* =========================================
           PAGE 3 LOGIC (QUEST TRACKER)
           ========================================= */
        let quests = [];
        function loadQuests() {
            const s = localStorage.getItem('mySoloQuests');
            if (s) { quests = JSON.parse(s); renderQuests(); }
        }
        function saveQuests() { localStorage.setItem('mySoloQuests', JSON.stringify(quests)); }
        function addQuest() {
            const n = document.getElementById('newQuestName').value || "Untitled";
            const l = parseInt(document.getElementById('newQuestLength').value) || 5;
            quests.unshift({ id: Date.now(), name: n, max: l, mom: 0, ten: 0, status: 'active' });
            saveQuests(); renderQuests();
            document.getElementById('newQuestName').value = "";
        }
        function updateQ(id, type, val) {
            const q = quests.find(x => x.id === id);
            if (!q || q.status !== 'active') return;
            if (type === 'mom') q.mom = Math.min(q.max, Math.max(0, q.mom + val));
            else q.ten = Math.min(q.max, Math.max(0, q.ten + val));
            if (q.mom >= q.max) q.status = 'success';
            else if (q.ten >= q.max) q.status = 'fail';
            saveQuests(); renderQuests();
        }
        function delQ(id) {
            if (confirm("Delete?")) { quests = quests.filter(x => x.id !== id); saveQuests(); renderQuests(); }
        }
        function renderQuests() {
            const c = document.getElementById('questContainer');
            c.innerHTML = quests.map(q => {
                const mp = (q.mom/q.max)*100, tp = (q.ten/q.max)*100;
                let badge = '<span style="background:#333; padding:2px 5px; border-radius:4px; font-size:0.8rem;">ACTIVE</span>';
                if (q.status==='success') badge = '<span style="background:#2e7d32; padding:2px 5px; border-radius:4px; font-size:0.8rem;">DONE</span>';
                if (q.status==='fail') badge = '<span style="background:#c62828; padding:2px 5px; border-radius:4px; font-size:0.8rem;">FAIL</span>';
                let ticks = ""; for(let i=0;i<q.max;i++) ticks+='<div class="tick"></div>';
                
                return `
                <div class="quest-card" style="opacity:${q.status!=='active'?0.7:1}">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <strong>${q.name}</strong> <div>${badge} <button onclick="delQ(${q.id})" style="background:none; border:none; color:#666; cursor:pointer;">x</button></div>
                    </div>
                    <div style="font-size:0.8rem; color:#aaa;">Success ${q.mom}/${q.max}</div>
                    <div class="bar-container"><div class="ticks-layer">${ticks}</div><div class="bar-fill fill-green" style="width:${mp}%"></div></div>
                    <div class="track-controls" style="margin-bottom:10px;">
                        <button class="btn-minus" onclick="updateQ(${q.id},'mom',-1)">-</button>
                        <button class="btn-plus-green" onclick="updateQ(${q.id},'mom',1)">Momentum +</button>
                    </div>
                    <div style="font-size:0.8rem; color:#aaa;">Danger ${q.ten}/${q.max}</div>
                    <div class="bar-container"><div class="ticks-layer">${ticks}</div><div class="bar-fill fill-red" style="width:${tp}%"></div></div>
                    <div class="track-controls">
                        <button class="btn-minus" onclick="updateQ(${q.id},'ten',-1)">-</button>
                        <button class="btn-plus-red" onclick="updateQ(${q.id},'ten',1)">Tension +</button>
                    </div>
                </div>`;
            }).join('');
        }

        // Init
        loadQuests();

    </script>
</body>
</html>
